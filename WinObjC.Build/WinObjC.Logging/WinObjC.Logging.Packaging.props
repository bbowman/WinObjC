<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
      <GitThisAssembly>true</GitThisAssembly>
      <InferLegacyPackageReferences>false</InferLegacyPackageReferences>
  </PropertyGroup>
    
  <PropertyGroup>
      <PackageId>WinObjC.Logging</PackageId>
      <Title>WinObjC.Logging</Title>
      <Authors>Microsoft</Authors>
      <Owners>Microsoft</Owners>
      <Summary>WinObjC.Logging</Summary>
      <Description>WinObjC.Logging</Description>
      <PackageReleaseNotes>
      </PackageReleaseNotes>
      <PackageProjectUrl>
      </PackageProjectUrl>
      <PackageLicenseUrl>
      </PackageLicenseUrl>
      <Copyright>Copyright Â© Microsoft</Copyright>
      <PackageTags>WinObjC.Logging</PackageTags>
      <IsDevelopmentDependency>true</IsDevelopmentDependency>
      <IncludeSymbolsInPackage>false</IncludeSymbolsInPackage>
      <IncludeFrameworkReferencesInPackage>false</IncludeFrameworkReferencesInPackage>
      <NoPackageAnalysis>true</NoPackageAnalysis>
  </PropertyGroup>

  <PropertyGroup>
    <GetPackageVersionDependsOn>SetPackageVersion;$(GetPackageVersionDependsOn);</GetPackageVersionDependsOn>
  </PropertyGroup>

  <!-- Inline task to check for timestamp file existence and creation-->  
  <UsingTask  
    TaskName="CreateTimestampFileIfNeeded"  
    TaskFactory="CodeTaskFactory"  
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v12.0.dll" >  
    <ParameterGroup>
      <TimestampFile ParameterType="System.String" Required="true" />
      <Timestamp ParameterType="System.String" Output="true" />  
    </ParameterGroup>
    <Task>
      <Reference Include="System" />
      <Reference Include="System.IO" />
      <Reference Include="System.Threading" />
      <Using Namespace="System" />
      <Using Namespace="System.IO" />
      <Using Namespace="System.Threading" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
          var mutex = new Mutex(false, TimestampFile.Replace("\\", "."));
          try
          {
            mutex.WaitOne();
          } catch (AbandonedMutexException e)
          {
          }
          
          if (!File.Exists(TimestampFile)) {
              File.Create(TimestampFile);
          }  

          Timestamp = File.GetCreationTimeUtc(TimestampFile).ToString("yyyyMMddHHmmss");
          mutex.ReleaseMutex();
        ]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="SetPackageVersion" DependsOnTargets="$(GitVersionDependsOn)" >

    <Error Condition="'$(GitBranch)' == ''"
           Text="Cannot determine git branch. Please make sure GitInfo is listed in the project.json for this project and that git.exe is part of the PATH environment variable." />

    <Warning Condition="'$(SolutionPath)' == ''"
           Text="Cannot determine solution build time. Package version dependencies may be inconsistent as a result. Please make sure to build using .sln file." />

    <CreateTimestampFileIfNeeded Condition="'$(SolutionDir)' != ''" 
                                 TimestampFile="$(SolutionDir)$(PackageId).timestamp">
        <Output PropertyName="PackageTimestamp" TaskParameter="Timestamp" />  
    </CreateTimestampFileIfNeeded>



    <PropertyGroup>
      <PackageTimestamp Condition="'$(PackageTimestamp)' == ''">$([System.DateTime]::Now.ToString(yyyyMMddHHmmss))</PackageTimestamp>

      <PackageVersion Condition="'$(PackageVersion)' == '' And '$(GitBranch)' == 'master'">$(GitBaseVersionMajor).$(GitBaseVersionMinor).$(PackageTimestamp)</PackageVersion>
      <PackageVersion Condition="'$(PackageVersion)' == '' And '$(GitBranch)' == 'develop'">$(GitBaseVersionMajor).$(GitBaseVersionMinor).$([MSBuild]::Add('$(GitBaseVersionPatch)', '1'))-$(PackageTimestamp).dev</PackageVersion>
      <PackageVersion Condition="'$(PackageVersion)' == ''">$(GitBaseVersionMajor).$(GitBaseVersionMinor).$([MSBuild]::Add('$(GitBaseVersionPatch)', '1'))-$(PackageTimestamp).pr</PackageVersion>
    </PropertyGroup>
  </Target>
  <Target Name="DeletePackageTimestampFile" Condition="'$(SolutionDir)' != ''" DependsOnTargets="SetPackageVersion" BeforeTargets="Pack">

    <!-- This target should only run for the actual packaging project as the pack target itself should never be run on anything but a .nuproj -->
    <Delete Files="$(SolutionDir)$(PackageId).timestamp" TreatErrorsAsWarnings="true"/>
  </Target>

</Project>